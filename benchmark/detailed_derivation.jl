
PP = get_initial_covariance(Val(:theoretical), values, coordinates, dimensions)
observables = data_in_deviations

T = size(observables, 2) + 1

u = [zeros(size(C,2)) for _ in 1:T]

u_mid = deepcopy(u)

z = [zeros(size(observables, 1)) for _ in 1:T]

P_mid = [deepcopy(PP) for _ in 1:T]

temp_N_N = similar(PP)

P = deepcopy(P_mid)

B_prod = ğ
# Ct = collect(C')
CP = [zero(C) for _ in 1:T]

K = [zero(C') for _ in 1:T]

cc = C * C'

V = [zero(cc) for _ in 1:T]

invV = [zero(cc) for _ in 1:T]

V[1] += â„’.I
invV[1] = inv(V[1])

innovation = deepcopy(z)

# V[1] .= C * P[1] * C'

loglik = (0.0)



for t in 2:T
    CP[t] .= C * P_mid[t-1]

    V[t] .= CP[t] * C'

    luV = â„’.lu(V[t], check = false)

    Vdet = â„’.det(luV)
    
    invV[t] .= inv(luV)
    
    innovation[t] .= observables[:, t-1] - z[t-1]
    
    loglik += log(Vdet) + innovation[t]' * invV[t] * innovation[t]

    K[t] .= P_mid[t-1] * C' * invV[t]

    u[t] .= K[t] * innovation[t] + u_mid[t-1]
    
    P[t] .= P_mid[t-1] - K[t] * CP[t]

    u_mid[t] .= A * u[t]

    z[t] .= C * u_mid[t]

    P_mid[t] .= A * P[t] * A' + B_prod
end

zz = -(loglik + ((size(data_in_deviations, 2) - presample_periods) * size(data_in_deviations, 1)) * log(2 * 3.141592653589793)) / 2 


# reverse pass
zz = -(loglik + ((size(data_in_deviations, 2) - presample_periods) * size(data_in_deviations, 1)) * log(2 * 3.141592653589793)) / 2 
âˆ‚zâˆ‚z = 1

# z = -(wâ¿â»Â¹ + wâ¿â»Â²) / 2
âˆ‚zâˆ‚wâ¿â»Â¹ = -âˆ‚zâˆ‚z/ 2
âˆ‚zâˆ‚wâ¿â»Â² = -âˆ‚zâˆ‚z/ 2

# wâ¿â»Â¹ = loglik = wâ¿â»Â³â‚ + wâ¿â»Â³â‚‚ = for t in 2:4 logdet(V[t]) + innovation[t]' * invV[t] * innovation[t] end
âˆ‚wâ¿â»Â¹âˆ‚wâ¿â»Â³â‚ = âˆ‚zâˆ‚wâ¿â»Â¹
âˆ‚wâ¿â»Â¹âˆ‚wâ¿â»Â³â‚‚ = âˆ‚zâˆ‚wâ¿â»Â¹
âˆ‚wâ¿â»Â¹âˆ‚wâ¿â»Â³â‚ƒ = âˆ‚zâˆ‚wâ¿â»Â¹

# branch wâ¿â»Â³â‚
# wâ¿â»Â³â‚ = wâ¿â»â´â‚ + wâ¿â»âµâ‚ = logdet(V[2]) + innovation[2]' * invV[2] * innovation[2]
âˆ‚wâ¿â»Â³â‚âˆ‚wâ¿â»â´â‚ = âˆ‚wâ¿â»Â¹âˆ‚wâ¿â»Â³â‚
âˆ‚wâ¿â»Â³â‚âˆ‚wâ¿â»âµâ‚ = âˆ‚wâ¿â»Â¹âˆ‚wâ¿â»Â³â‚

# branch wâ¿â»â´â‚
wâ¿â»â´â‚ = logdet(wâ¿â»â¶â‚)
wâ¿â»â¶â‚ = C * P[1] * C'#V[2]
âˆ‚wâ¿â»â´â‚âˆ‚wâ¿â»â¶â‚ = âˆ‚wâ¿â»Â³â‚âˆ‚wâ¿â»â´â‚ * inv(wâ¿â»â¶â‚)'

# wâ¿â»â¶â‚ = V[2] = wâ¿â»â·â‚ * C' = CP[2] * C'
# wâ¿â»â·â‚ = CP[2] = C * P_mid[1]
âˆ‚wâ¿â»â¶â‚âˆ‚wâ¿â»â·â‚ = âˆ‚wâ¿â»â´â‚âˆ‚wâ¿â»â¶â‚ * C

âˆ‚wâ¿â»â·â‚âˆ‚P = C' * âˆ‚wâ¿â»â¶â‚âˆ‚wâ¿â»â·â‚


# âˆ‚zâˆ‚P_mid = âˆ‚zâˆ‚z * âˆ‚zâˆ‚wâ¿â»Â¹ * âˆ‚wâ¿â»Â¹âˆ‚wâ¿â»Â³â‚ * âˆ‚wâ¿â»Â³â‚âˆ‚wâ¿â»â´â‚ * âˆ‚wâ¿â»â´â‚âˆ‚wâ¿â»â¶â‚ *  âˆ‚wâ¿â»â¶â‚âˆ‚wâ¿â»â·â‚ * âˆ‚wâ¿â»â·â‚âˆ‚P_mid


# branch wâ¿â»Â³â‚‚
# wâ¿â»Â³â‚‚ = wâ¿â»â´â‚‚ + wâ¿â»âµâ‚‚ = logdet(V[3]) + innovation[3]' * invV[3] * innovation[3]
âˆ‚wâ¿â»Â³â‚‚âˆ‚wâ¿â»â´â‚‚ = âˆ‚wâ¿â»Â¹âˆ‚wâ¿â»Â³â‚‚
âˆ‚wâ¿â»Â³â‚‚âˆ‚wâ¿â»âµâ‚‚ = âˆ‚wâ¿â»Â¹âˆ‚wâ¿â»Â³â‚‚

# branch wâ¿â»â´â‚‚
# wâ¿â»â´â‚‚ = logdet(wâ¿â»â¶â‚‚)
wâ¿â»â¶â‚‚ = C * P_mid[2] * C'#V[3]
âˆ‚wâ¿â»â´â‚‚âˆ‚wâ¿â»â¶â‚‚ = âˆ‚wâ¿â»Â³â‚‚âˆ‚wâ¿â»â´â‚‚ * inv(wâ¿â»â¶â‚‚)'

# wâ¿â»â¶â‚‚ = V[3] = wâ¿â»â·â‚‚ * C' = CP[3] * C'
# wâ¿â»â·â‚‚ = CP[3] = C * P_mid[2] = C * wâ¿â»â¸â‚‚
âˆ‚wâ¿â»â¶â‚‚âˆ‚wâ¿â»â·â‚‚ = âˆ‚wâ¿â»â´â‚‚âˆ‚wâ¿â»â¶â‚‚ * C

âˆ‚wâ¿â»â·â‚‚âˆ‚wâ¿â»â¸â‚‚ = C' * âˆ‚wâ¿â»â¶â‚‚âˆ‚wâ¿â»â·â‚‚

# wâ¿â»â¸â‚‚ = P_mid[2] = wâ¿â»â¹â‚‚ + B_prod = A * P[2] * A' + B_prod

âˆ‚wâ¿â»â¸â‚‚âˆ‚wâ¿â»â¹â‚‚ = âˆ‚wâ¿â»â·â‚‚âˆ‚wâ¿â»â¸â‚‚

# wâ¿â»â¹â‚‚ = A * P[2] * A' = AP[2] * A' = wâ¿â»Â¹â°â‚‚ * A'
wâ¿â»Â¹â°â‚‚ = A * P[2]
âˆ‚wâ¿â»â¹â‚‚âˆ‚A = (wâ¿â»Â¹â°â‚‚' * âˆ‚wâ¿â»â¸â‚‚âˆ‚wâ¿â»â¹â‚‚)'

âˆ‚wâ¿â»â¹â‚‚âˆ‚wâ¿â»Â¹â°â‚‚ = âˆ‚wâ¿â»â¸â‚‚âˆ‚wâ¿â»â¹â‚‚ * A
âˆ‚wâ¿â»Â¹â°â‚‚âˆ‚A = âˆ‚wâ¿â»â¹â‚‚âˆ‚wâ¿â»Â¹â°â‚‚ * P[2]'

âˆ‚zâˆ‚A = âˆ‚wâ¿â»Â¹â°â‚‚âˆ‚A + âˆ‚wâ¿â»â¹â‚‚âˆ‚A

# âˆ‚zâˆ‚A = âˆ‚wâ¿â»â·â‚‚âˆ‚wâ¿â»â¸â‚‚ * âˆ‚zâˆ‚z * âˆ‚zâˆ‚wâ¿â»Â¹ * âˆ‚wâ¿â»Â¹âˆ‚wâ¿â»Â³â‚ * âˆ‚wâ¿â»Â³â‚‚âˆ‚wâ¿â»â´â‚‚ * âˆ‚wâ¿â»â´â‚‚âˆ‚wâ¿â»â¶â‚‚ * âˆ‚wâ¿â»â¶â‚‚âˆ‚wâ¿â»â·â‚‚  * âˆ‚wâ¿â»â¸â‚‚âˆ‚wâ¿â»â¹â‚‚ * (âˆ‚wâ¿â»â¹â‚‚âˆ‚A + âˆ‚wâ¿â»â¹â‚‚âˆ‚wâ¿â»Â¹â°â‚‚ * âˆ‚wâ¿â»Â¹â°â‚‚âˆ‚A)
âˆ‚zâˆ‚A = -1/2 * C' * inv(C * P_mid[2] * C')' * C * (A * P[2] + A * P[2]')


zyggrad = Zygote.gradient(x -> -1/2*logdet(C * (x * (P[2] - P[2] * C' * invV[3] * C * P[2]) * x' + ğ) * C'), A)[1]

isapprox(âˆ‚zâˆ‚A, zyggrad)

# continue with wâ¿â»Â¹â°â‚‚ derivative wrt P[2]
âˆ‚wâ¿â»â¹â‚‚âˆ‚wâ¿â»Â¹â°â‚‚ = âˆ‚wâ¿â»â¸â‚‚âˆ‚wâ¿â»â¹â‚‚ * A
# AP[2] = A * P[2] = A * wâ¿â»Â¹Â¹â‚‚
âˆ‚wâ¿â»Â¹â°â‚‚âˆ‚wâ¿â»Â¹Â¹â‚‚ = A' * âˆ‚wâ¿â»â¹â‚‚âˆ‚wâ¿â»Â¹â°â‚‚

# wâ¿â»Â¹Â¹â‚‚ = P[2] =  P_mid[1] - K[2] * CP[2] = wâ¿â»Â¹Â²â‚‚ - wâ¿â»Â¹Â³â‚‚
âˆ‚wâ¿â»Â¹Â¹â‚‚âˆ‚P = âˆ‚wâ¿â»Â¹â°â‚‚âˆ‚wâ¿â»Â¹Â¹â‚‚
âˆ‚wâ¿â»Â¹Â¹â‚‚âˆ‚wâ¿â»Â¹Â³â‚‚ = -âˆ‚wâ¿â»Â¹â°â‚‚âˆ‚wâ¿â»Â¹Â¹â‚‚


# wâ¿â»Â¹Â³â‚‚ = K[2] * CP[2] = wâ¿â»Â¹â´â‚‚ * wâ¿â»Â¹âµâ‚‚
âˆ‚wâ¿â»Â¹Â³â‚‚âˆ‚wâ¿â»Â¹â´â‚‚ = âˆ‚wâ¿â»Â¹Â¹â‚‚âˆ‚wâ¿â»Â¹Â³â‚‚ * CP[2]'
âˆ‚wâ¿â»Â¹Â³â‚‚âˆ‚wâ¿â»Â¹âµâ‚‚ = K[2]' * âˆ‚wâ¿â»Â¹Â¹â‚‚âˆ‚wâ¿â»Â¹Â³â‚‚


# wâ¿â»Â¹â´â‚‚ = K[2] = PC[1] * invV[2] = P_mid[1] * C' * invV[2] = wâ¿â»Â¹â¶â‚‚ * wâ¿â»Â¹â·â‚‚
âˆ‚wâ¿â»Â¹â´â‚‚âˆ‚wâ¿â»Â¹â¶â‚‚ = âˆ‚wâ¿â»Â¹Â³â‚‚âˆ‚wâ¿â»Â¹â´â‚‚ * invV[2]'
âˆ‚wâ¿â»Â¹â´â‚‚âˆ‚wâ¿â»Â¹â·â‚‚ = (P_mid[1] * C')' * âˆ‚wâ¿â»Â¹Â³â‚‚âˆ‚wâ¿â»Â¹â´â‚‚

wâ¿â»Â¹â¶â‚‚ = P_mid[1] * C'
âˆ‚wâ¿â»Â¹â¶â‚‚âˆ‚P = âˆ‚wâ¿â»Â¹â´â‚‚âˆ‚wâ¿â»Â¹â¶â‚‚ * C

# wâ¿â»Â¹â·â‚‚ = inv(V[2]) = inv(wâ¿â»Â¹â¸â‚‚)
âˆ‚wâ¿â»Â¹â·â‚‚âˆ‚wâ¿â»Â¹â¸â‚‚ = -invV[2]' * âˆ‚wâ¿â»Â¹â´â‚‚âˆ‚wâ¿â»Â¹â·â‚‚ * invV[2]'

# wâ¿â»Â¹â¸â‚‚ = V[2] = CP[2] * C' = wâ¿â»Â¹â¹â‚‚ * C' = wâ¿â»â¶â‚
# wâ¿â»Â¹â¹â‚‚ = CP[2] = C * P_mid[1]
âˆ‚wâ¿â»Â¹â¸â‚‚âˆ‚wâ¿â»Â¹â¹â‚‚ = âˆ‚wâ¿â»Â¹â·â‚‚âˆ‚wâ¿â»Â¹â¸â‚‚ * C
âˆ‚wâ¿â»Â¹â¹â‚‚âˆ‚P = C' * âˆ‚wâ¿â»Â¹â¸â‚‚âˆ‚wâ¿â»Â¹â¹â‚‚


# wâ¿â»Â¹â¹â‚‚ = wâ¿â»Â¹âµâ‚‚
âˆ‚wâ¿â»Â¹âµâ‚‚âˆ‚P = C' * âˆ‚wâ¿â»Â¹Â³â‚‚âˆ‚wâ¿â»Â¹âµâ‚‚


âˆ‚zâˆ‚P = âˆ‚wâ¿â»Â¹âµâ‚‚âˆ‚P + âˆ‚wâ¿â»Â¹â¹â‚‚âˆ‚P + âˆ‚wâ¿â»Â¹â¶â‚‚âˆ‚P + âˆ‚wâ¿â»Â¹Â¹â‚‚âˆ‚P + âˆ‚wâ¿â»â·â‚âˆ‚P

isapprox(âˆ‚wâ¿â»Â¹âµâ‚‚âˆ‚P, C' * K[2]' * -A' * C' * -âˆ‚zâˆ‚z / 2 * invV[3]' * C * A)

isapprox(âˆ‚wâ¿â»Â¹â¹â‚‚âˆ‚P, C' * -invV[2]' * (P_mid[1] * C')' * -A' * C' * -âˆ‚zâˆ‚z / 2 * invV[3]' * C * A * CP[2]' * invV[2]' * C)
# isapprox(âˆ‚wâ¿â»Â¹â¹â‚‚âˆ‚P, C' * -K[2]' * -A' * C' * -âˆ‚zâˆ‚z / 2 * invV[3]' * C * A * K[2] * C)

isapprox(âˆ‚wâ¿â»Â¹â¶â‚‚âˆ‚P, -A' * C' * -âˆ‚zâˆ‚z / 2 * invV[3]' * C * A * CP[2]' * invV[2]' * C)
# isapprox(âˆ‚wâ¿â»Â¹â¶â‚‚âˆ‚P, -A' * C' * -âˆ‚zâˆ‚z / 2 * invV[3]' * C * A * K[2] * C)

isapprox(âˆ‚wâ¿â»Â¹Â¹â‚‚âˆ‚P, A' * C' * -âˆ‚zâˆ‚z / 2 * invV[3]' * C * A)

isapprox(âˆ‚wâ¿â»â·â‚âˆ‚P, C' * -âˆ‚zâˆ‚z/ 2 * invV[2]' * C)




core = C' * -âˆ‚zâˆ‚z / 2 * invV[3]' * C
isapprox(âˆ‚wâ¿â»Â¹âµâ‚‚âˆ‚P, C' * K[2]' * -A' * core * A)

isapprox(âˆ‚wâ¿â»Â¹â¹â‚‚âˆ‚P, C' * -invV[2]' * (P_mid[1] * C')' * -A' * core * A * CP[2]' * invV[2]' * C)
# isapprox(âˆ‚wâ¿â»Â¹â¹â‚‚âˆ‚P, C' * -K[2]' * -A' * core * A * K[2] * C)

isapprox(âˆ‚wâ¿â»Â¹â¶â‚‚âˆ‚P, -A' * core * A * CP[2]' * invV[2]' * C)
# isapprox(âˆ‚wâ¿â»Â¹â¶â‚‚âˆ‚P, -A' * core * A * K[2] * C)

isapprox(âˆ‚wâ¿â»Â¹Â¹â‚‚âˆ‚P, A' * core * A)


core = C' * -âˆ‚zâˆ‚z / 2 * invV[3]' * C
AcoreA = A' * core * A
AcoreA * (â„’.I - CP[2]' * invV[2]' * C) + C' * invV[2]' * (P_mid[1] * C')' * AcoreA * CP[2]' * invV[2]' * C - C' * K[2]' * AcoreA


zyggrad = Zygote.gradient(x -> -1/2*logdet(C * x * C'), PP)[1]

isapprox(âˆ‚wâ¿â»â·â‚âˆ‚P, zyggrad)

âˆ‚wâ¿â»Â¹Â¹â‚‚âˆ‚P

zyggrad = Zygote.gradient(x -> -1/2*(logdet(C * (A * (x - PP * C' * inv(C * PP * C') * C * PP) * A' + ğ) * C')), PP)[1]
isapprox(âˆ‚wâ¿â»Â¹Â¹â‚‚âˆ‚P, zyggrad)


zyggrad = Zygote.gradient(x -> -1/2*(logdet(C * (A * (x) * A' + ğ) * C')), PP)[1]



zyggrad = Zygote.gradient(x -> -1/2*(logdet(C * (A * (x - x * C' * inv(C * x * C') * C * x) * A' + ğ) * C') + logdet(C * x * C')), PP)[1]
forgrad = ForwardDiff.gradient(x -> -1/2*(logdet(C * (A * (x - x * C' * inv(C * x * C') * C * x) * A' + ğ) * C') + logdet(C * x * C')), PP)

isapprox(zyggrad, âˆ‚zâˆ‚P)
isapprox(zyggrad, forgrad)


# fingrad = FiniteDifferences.grad(FiniteDifferences.central_fdm(4,1),
# x -> begin
# P_mid[1] = deepcopy(x)
# P[1] = deepcopy(x)
# loglik = 0.0
# for t in 2:3
#     CP[t] .= C * P_mid[t-1]

#     V[t] .= CP[t] * C'

#     luV = â„’.lu(V[t], check = false)

#     Vdet = â„’.det(luV)
    
#     invV[t] .= inv(luV)
    
#     innovation[t] .= observables[:, t-1] - z[t-1]
    
#     loglik += log(Vdet)# + innovation[t]' * invV[t] * innovation[t]

#     K[t] .= P_mid[t-1] * C' * invV[t]

#     u[t] .= K[t] * innovation[t] + u_mid[t-1]
    
#     P[t] .= P_mid[t-1] - K[t] * CP[t]

#     u_mid[t] .= A * u[t]

#     z[t] .= C * u_mid[t]

#     P_mid[t] .= A * P[t] * A' + B_prod
# end
# return -1/2*loglik
# end, PP)[1]

zyggrad - fingrad


core = C' * -âˆ‚zâˆ‚z / 2 * invV[4]' * C
AcoreA = A' * core * A
AcoreA = A' * AcoreA * A
AcoreA * (â„’.I - CP[2]' * invV[2]' * C) + C' * invV[2]' * (P_mid[1] * C')' * AcoreA * CP[2]' * invV[2]' * C - C' * K[2]' * AcoreA



isapprox(âˆ‚zâˆ‚P, fingrad)
isapprox(zyggrad, fingrad)
maximum(abs, zyggrad - fingrad)



# continue with t = 4
# branch wâ¿â»Â³â‚ƒ
# wâ¿â»Â³â‚ƒ = wâ¿â»â´â‚ƒ + wâ¿â»âµâ‚ƒ = logdet(V[4]) + innovation[4]' * invV[4] * innovation[4]
âˆ‚wâ¿â»Â³â‚ƒâˆ‚wâ¿â»â´â‚ƒ = âˆ‚wâ¿â»Â¹âˆ‚wâ¿â»Â³â‚ƒ
âˆ‚wâ¿â»Â³â‚ƒâˆ‚wâ¿â»âµâ‚ƒ = âˆ‚wâ¿â»Â¹âˆ‚wâ¿â»Â³â‚ƒ

# branch wâ¿â»â´â‚ƒ
# wâ¿â»â´â‚ƒ = logdet(wâ¿â»â¶â‚ƒ)
wâ¿â»â¶â‚ƒ = C * P_mid[3] * C'#V[4]
âˆ‚wâ¿â»â´â‚ƒâˆ‚wâ¿â»â¶â‚ƒ = âˆ‚wâ¿â»Â³â‚ƒâˆ‚wâ¿â»â´â‚ƒ * inv(wâ¿â»â¶â‚ƒ)'

# wâ¿â»â¶â‚ƒ = V[4] = wâ¿â»â·â‚ƒ * C' = CP[4] * C'
# wâ¿â»â·â‚ƒ = CP[4] = C * P_mid[3] = C * wâ¿â»â¸â‚ƒ
âˆ‚wâ¿â»â¶â‚ƒâˆ‚wâ¿â»â·â‚ƒ = âˆ‚wâ¿â»â´â‚ƒâˆ‚wâ¿â»â¶â‚ƒ * C

âˆ‚wâ¿â»â·â‚ƒâˆ‚wâ¿â»â¸â‚ƒ = C' * âˆ‚wâ¿â»â¶â‚ƒâˆ‚wâ¿â»â·â‚ƒ

# wâ¿â»â¸â‚ƒ = P_mid[3] = wâ¿â»â¹â‚ƒ + B_prod = A * P[3] * A' + B_prod

âˆ‚wâ¿â»â¸â‚ƒâˆ‚wâ¿â»â¹â‚ƒ = âˆ‚wâ¿â»â·â‚ƒâˆ‚wâ¿â»â¸â‚ƒ

# wâ¿â»â¹â‚ƒ = A * P[3] * A' = AP[3] * A' = wâ¿â»Â¹â°â‚ƒ * A'
wâ¿â»Â¹â°â‚ƒ = A * P[3]
âˆ‚wâ¿â»â¹â‚ƒâˆ‚A = (wâ¿â»Â¹â°â‚ƒ' * âˆ‚wâ¿â»â¸â‚ƒâˆ‚wâ¿â»â¹â‚ƒ)'

âˆ‚wâ¿â»â¹â‚ƒâˆ‚wâ¿â»Â¹â°â‚ƒ = âˆ‚wâ¿â»â¸â‚ƒâˆ‚wâ¿â»â¹â‚ƒ * A

âˆ‚wâ¿â»Â¹â°â‚ƒâˆ‚A = âˆ‚wâ¿â»â¹â‚ƒâˆ‚wâ¿â»Â¹â°â‚ƒ * P[3]'

âˆ‚zâˆ‚A = âˆ‚wâ¿â»Â¹â°â‚ƒâˆ‚A + âˆ‚wâ¿â»â¹â‚ƒâˆ‚A

# âˆ‚zâˆ‚A = âˆ‚wâ¿â»â·â‚ƒâˆ‚wâ¿â»â¸â‚ƒ * âˆ‚zâˆ‚z * âˆ‚zâˆ‚wâ¿â»Â¹ * âˆ‚wâ¿â»Â¹âˆ‚wâ¿â»Â³â‚ * âˆ‚wâ¿â»Â³â‚ƒâˆ‚wâ¿â»â´â‚ƒ * âˆ‚wâ¿â»â´â‚ƒâˆ‚wâ¿â»â¶â‚ƒ * âˆ‚wâ¿â»â¶â‚ƒâˆ‚wâ¿â»â·â‚ƒ  * âˆ‚wâ¿â»â¸â‚ƒâˆ‚wâ¿â»â¹â‚ƒ * (âˆ‚wâ¿â»â¹â‚ƒâˆ‚A + âˆ‚wâ¿â»â¹â‚ƒâˆ‚wâ¿â»Â¹â°â‚ƒ * âˆ‚wâ¿â»Â¹â°â‚ƒâˆ‚A)
âˆ‚zâˆ‚A = -1/2 * C' * inv(C * P_mid[3] * C')' * C * (A * P[3] + A * P[3]')


zyggrad = Zygote.gradient(x -> -1/2*logdet(C * (x * (P[3] - P[3] * C' * invV[4] * C * P[3]) * x' + ğ) * C'), A)[1]

isapprox(âˆ‚zâˆ‚A, zyggrad)

# continue with wâ¿â»Â¹â°â‚ƒ derivative wrt P[3]
âˆ‚wâ¿â»â¹â‚ƒâˆ‚wâ¿â»Â¹â°â‚ƒ = âˆ‚wâ¿â»â¸â‚ƒâˆ‚wâ¿â»â¹â‚ƒ * A
# AP[3] = A * P[3] = A * wâ¿â»Â¹Â¹â‚ƒ
âˆ‚wâ¿â»Â¹â°â‚ƒâˆ‚wâ¿â»Â¹Â¹â‚ƒ = A' * âˆ‚wâ¿â»â¹â‚ƒâˆ‚wâ¿â»Â¹â°â‚ƒ

# wâ¿â»Â¹Â¹â‚ƒ = P[3] =  P_mid[2] - K[3] * CP[3] = wâ¿â»Â¹Â²â‚ƒ - wâ¿â»Â¹Â³â‚ƒ
âˆ‚wâ¿â»Â¹Â¹â‚ƒâˆ‚wâ¿â»Â¹Â²â‚ƒ = âˆ‚wâ¿â»Â¹â°â‚ƒâˆ‚wâ¿â»Â¹Â¹â‚ƒ
âˆ‚wâ¿â»Â¹Â¹â‚ƒâˆ‚wâ¿â»Â¹Â³â‚ƒ = -âˆ‚wâ¿â»Â¹â°â‚ƒâˆ‚wâ¿â»Â¹Â¹â‚ƒ

# wâ¿â»Â¹Â²â‚ƒ = P_mid[2] = wâ¿â»Â¹Â²â‚ƒÂ¹ + B_prod = A * P[2] * A' + B_prod
âˆ‚wâ¿â»Â¹Â²â‚ƒâˆ‚wâ¿â»Â¹Â²â‚ƒÂ¹ = âˆ‚wâ¿â»Â¹Â¹â‚ƒâˆ‚wâ¿â»Â¹Â²â‚ƒ

# wâ¿â»Â¹Â²â‚ƒÂ¹ = A * P[2] * A' = AP[2] * A' = wâ¿â»Â¹Â²â‚ƒÂ² * A'
wâ¿â»Â¹Â²â‚ƒÂ² = A * P[2]
âˆ‚wâ¿â»Â¹Â²â‚ƒÂ¹âˆ‚A = (wâ¿â»Â¹Â²â‚ƒÂ²' * âˆ‚wâ¿â»Â¹Â¹â‚ƒâˆ‚wâ¿â»Â¹Â²â‚ƒ)'
âˆ‚wâ¿â»Â¹Â²â‚ƒÂ¹âˆ‚wâ¿â»Â¹Â²â‚ƒÂ² = âˆ‚wâ¿â»Â¹Â¹â‚ƒâˆ‚wâ¿â»Â¹Â²â‚ƒ * A

âˆ‚wâ¿â»Â¹Â²â‚ƒÂ²âˆ‚A = âˆ‚wâ¿â»Â¹Â²â‚ƒÂ¹âˆ‚wâ¿â»Â¹Â²â‚ƒÂ² * P[2]'

# effect through wâ¿â»Â¹Â³â‚ƒ = K[3] * CP[3]
# wâ¿â»Â¹Â³â‚ƒ = K[3] * CP[3] = wâ¿â»Â¹â´â‚ƒ * wâ¿â»Â¹âµâ‚ƒ
âˆ‚wâ¿â»Â¹Â³â‚ƒâˆ‚wâ¿â»Â¹â´â‚ƒ = âˆ‚wâ¿â»Â¹Â¹â‚ƒâˆ‚wâ¿â»Â¹Â³â‚ƒ * CP[3]'
âˆ‚wâ¿â»Â¹Â³â‚ƒâˆ‚wâ¿â»Â¹âµâ‚ƒ = K[3]' * âˆ‚wâ¿â»Â¹Â¹â‚ƒâˆ‚wâ¿â»Â¹Â³â‚ƒ

# wâ¿â»Â¹â´â‚ƒ = K[3] = PC[2] * invV[3] = P_mid[2] * C' * invV[3] = wâ¿â»Â¹â¶â‚ƒ * wâ¿â»Â¹â·â‚ƒ
âˆ‚wâ¿â»Â¹â´â‚ƒâˆ‚wâ¿â»Â¹â¶â‚ƒ = âˆ‚wâ¿â»Â¹Â³â‚ƒâˆ‚wâ¿â»Â¹â´â‚ƒ * invV[3]'
âˆ‚wâ¿â»Â¹â´â‚ƒâˆ‚wâ¿â»Â¹â·â‚ƒ = (P_mid[2] * C')' * âˆ‚wâ¿â»Â¹Â³â‚ƒâˆ‚wâ¿â»Â¹â´â‚ƒ

# wâ¿â»Â¹â¶â‚ƒ = P_mid[2] * C' = wâ¿â»Â¹â¶â‚ƒÂ¹ * C'
âˆ‚wâ¿â»Â¹â¶â‚ƒâˆ‚wâ¿â»Â¹â¶â‚ƒÂ¹ = âˆ‚wâ¿â»Â¹â´â‚ƒâˆ‚wâ¿â»Â¹â¶â‚ƒ * C

# wâ¿â»Â¹â¶â‚ƒÂ¹ = P_mid[2] = wâ¿â»Â¹â¶â‚ƒÂ² + B_prod = A * P[2] * A' + B_prod
# wâ¿â»Â¹â¶â‚ƒÂ² = A * P[2] * A' = AP[2] * A' = wâ¿â»Â¹â¶â‚ƒÂ³ * A'
wâ¿â»Â¹â¶â‚ƒÂ³ = A * P[2]
âˆ‚wâ¿â»Â¹â¶â‚ƒÂ²âˆ‚A = (wâ¿â»Â¹â¶â‚ƒÂ³' * âˆ‚wâ¿â»Â¹â¶â‚ƒâˆ‚wâ¿â»Â¹â¶â‚ƒÂ¹)'
âˆ‚wâ¿â»Â¹â¶â‚ƒÂ²âˆ‚wâ¿â»Â¹â¶â‚ƒÂ³ = âˆ‚wâ¿â»Â¹â¶â‚ƒâˆ‚wâ¿â»Â¹â¶â‚ƒÂ¹ * A

âˆ‚wâ¿â»Â¹â¶â‚ƒÂ³âˆ‚A = âˆ‚wâ¿â»Â¹â¶â‚ƒÂ²âˆ‚wâ¿â»Â¹â¶â‚ƒÂ³ * P[2]'


# wâ¿â»Â¹â·â‚ƒ = inv(V[3]) = inv(wâ¿â»Â¹â¸â‚ƒ)
âˆ‚wâ¿â»Â¹â·â‚ƒâˆ‚wâ¿â»Â¹â¸â‚ƒ = -invV[3]' * âˆ‚wâ¿â»Â¹â´â‚ƒâˆ‚wâ¿â»Â¹â·â‚ƒ * invV[3]'

# wâ¿â»Â¹â¸â‚ƒ = V[3] = CP[3] * C' = wâ¿â»Â¹â¹â‚ƒ * C' = wâ¿â»â¶â‚
# wâ¿â»Â¹â¹â‚ƒ = CP[3] = C * P_mid[2] = C * wâ¿â»Â²â°â‚ƒ
âˆ‚wâ¿â»Â¹â¸â‚ƒâˆ‚wâ¿â»Â¹â¹â‚ƒ = âˆ‚wâ¿â»Â¹â·â‚ƒâˆ‚wâ¿â»Â¹â¸â‚ƒ * C
âˆ‚wâ¿â»Â¹â¹â‚ƒâˆ‚wâ¿â»Â²â°â‚ƒ = C' * âˆ‚wâ¿â»Â¹â¸â‚ƒâˆ‚wâ¿â»Â¹â¹â‚ƒ

# wâ¿â»Â²â°â‚ƒ = P_mid[2] = wâ¿â»Â²â°â‚ƒÂ² + B_prod = A * P[2] * A' + B_prod
# wâ¿â»Â²â°â‚ƒÂ² = A * P[2] * A' = AP[2] * A' = wâ¿â»Â²â°â‚ƒÂ³ * A'
wâ¿â»Â²â°â‚ƒÂ³ = A * P[2]
âˆ‚wâ¿â»Â²â°â‚ƒÂ²âˆ‚A = (wâ¿â»Â²â°â‚ƒÂ³' * âˆ‚wâ¿â»Â¹â¹â‚ƒâˆ‚wâ¿â»Â²â°â‚ƒ)'
âˆ‚wâ¿â»Â²â°â‚ƒÂ²âˆ‚wâ¿â»Â²â°â‚ƒÂ³ = âˆ‚wâ¿â»Â¹â¹â‚ƒâˆ‚wâ¿â»Â²â°â‚ƒ * A

âˆ‚wâ¿â»Â²â°â‚ƒÂ³âˆ‚A = âˆ‚wâ¿â»Â²â°â‚ƒÂ²âˆ‚wâ¿â»Â²â°â‚ƒÂ³ * P[2]'



# wâ¿â»Â¹â¹â‚ƒ = wâ¿â»Â¹âµâ‚ƒ = CP[3] = C * P_mid[2] = C * wâ¿â»Â¹âµâ‚ƒÂ¹
âˆ‚wâ¿â»Â¹âµâ‚ƒâˆ‚P = C' * âˆ‚wâ¿â»Â¹Â³â‚ƒâˆ‚wâ¿â»Â¹âµâ‚ƒ

âˆ‚wâ¿â»Â¹âµâ‚ƒâˆ‚wâ¿â»Â¹âµâ‚ƒÂ¹ = C' * âˆ‚wâ¿â»Â¹Â³â‚ƒâˆ‚wâ¿â»Â¹âµâ‚ƒ

# wâ¿â»Â¹âµâ‚ƒÂ¹ = P_mid[2] = wâ¿â»Â¹âµâ‚ƒÂ² + B_prod = A * P[2] * A' + B_prod
# wâ¿â»Â¹âµâ‚ƒÂ² = A * P[2] * A' = AP[2] * A' = wâ¿â»Â¹âµâ‚ƒÂ³ * A'
wâ¿â»Â¹âµâ‚ƒÂ¹ = A * P[2]
âˆ‚wâ¿â»Â¹âµâ‚ƒÂ²âˆ‚A = (wâ¿â»Â¹âµâ‚ƒÂ¹' * âˆ‚wâ¿â»Â¹âµâ‚ƒâˆ‚wâ¿â»Â¹âµâ‚ƒÂ¹)'
âˆ‚wâ¿â»Â¹âµâ‚ƒÂ²âˆ‚wâ¿â»Â¹âµâ‚ƒÂ³ = âˆ‚wâ¿â»Â¹âµâ‚ƒâˆ‚wâ¿â»Â¹âµâ‚ƒÂ¹ * A

âˆ‚wâ¿â»Â¹âµâ‚ƒÂ³âˆ‚A = âˆ‚wâ¿â»Â¹âµâ‚ƒÂ²âˆ‚wâ¿â»Â¹âµâ‚ƒÂ³ * P[2]'

âˆ‚zâˆ‚Aâ‚ƒ = âˆ‚wâ¿â»Â¹â°â‚ƒâˆ‚A + âˆ‚wâ¿â»â¹â‚ƒâˆ‚A + âˆ‚wâ¿â»Â¹Â²â‚ƒÂ¹âˆ‚A + âˆ‚wâ¿â»Â¹Â²â‚ƒÂ²âˆ‚A + âˆ‚wâ¿â»Â¹â¶â‚ƒÂ²âˆ‚A + âˆ‚wâ¿â»Â¹â¶â‚ƒÂ³âˆ‚A + âˆ‚wâ¿â»Â²â°â‚ƒÂ²âˆ‚A + âˆ‚wâ¿â»Â²â°â‚ƒÂ³âˆ‚A + âˆ‚wâ¿â»Â¹âµâ‚ƒÂ²âˆ‚A + âˆ‚wâ¿â»Â¹âµâ‚ƒÂ³âˆ‚A # this is correct and captues the effect for t = 4

âˆ‚wâ¿â»â¹â‚ƒâˆ‚A   â‰ˆ ((A * P[3])' *                                             C' * -âˆ‚zâˆ‚z/ 2 * inv(V[4])' * C    )'
âˆ‚wâ¿â»Â¹â°â‚ƒâˆ‚A  â‰ˆ                                                            C' * -âˆ‚zâˆ‚z/ 2 * inv(V[4])' * C     * A * P[3]'
âˆ‚wâ¿â»Â¹Â²â‚ƒÂ¹âˆ‚A â‰ˆ ((A * P[2])' * A' *                                        C' * -âˆ‚zâˆ‚z/ 2 * inv(V[4])' * C     * A)'
âˆ‚wâ¿â»Â¹âµâ‚ƒÂ²âˆ‚A â‰ˆ ((A * P[2])' * C' * K[3]' * -A' *                          C' * -âˆ‚zâˆ‚z/ 2 * inv(V[4])' * C     * A)'
âˆ‚wâ¿â»Â¹Â²â‚ƒÂ²âˆ‚A â‰ˆ A' *                                                       C' * -âˆ‚zâˆ‚z/ 2 * inv(V[4])' * C     * A * A * P[2]'
âˆ‚wâ¿â»Â¹âµâ‚ƒÂ³âˆ‚A â‰ˆ C' * K[3]' * -A' *                                         C' * -âˆ‚zâˆ‚z/ 2 * inv(V[4])' * C     * A * A * P[2]'
âˆ‚wâ¿â»Â¹â¶â‚ƒÂ²âˆ‚A â‰ˆ ((A * P[2])' * -A' *                                       C' * -âˆ‚zâˆ‚z/ 2 * inv(V[4])' * C     * A * CP[3]' * inv(V[3])' * C)'
âˆ‚wâ¿â»Â²â°â‚ƒÂ²âˆ‚A â‰ˆ ((A * P[2])' * C' * -invV[3]'* (P_mid[2] * C')' * -A' *    C' * -âˆ‚zâˆ‚z/ 2 * inv(V[4])' * C     * A * CP[3]' * inv(V[3])' * C)'
âˆ‚wâ¿â»Â¹â¶â‚ƒÂ³âˆ‚A â‰ˆ -A' *                                                      C' * -âˆ‚zâˆ‚z/ 2 * inv(V[4])' * C     * A * CP[3]' * inv(V[3])' * C * A * P[2]'
âˆ‚wâ¿â»Â²â°â‚ƒÂ³âˆ‚A â‰ˆ C' *  -invV[3]' * (P_mid[2] * C')' * -A' *                 C' * -âˆ‚zâˆ‚z/ 2 * inv(V[4])' * C     * A * CP[3]' * inv(V[3])' * C * A * P[2]'

âˆ‚zâˆ‚Aâ‚‚ = âˆ‚wâ¿â»Â¹â°â‚‚âˆ‚A + âˆ‚wâ¿â»â¹â‚‚âˆ‚A # this is correct and captues the effect for t = 3

âˆ‚wâ¿â»Â¹â°â‚‚âˆ‚A â‰ˆ C' * -âˆ‚zâˆ‚z/ 2 * inv(V[3])' * C * A * P[2]'
âˆ‚wâ¿â»â¹â‚‚âˆ‚A  â‰ˆ ((A * P[2])' * C' * -âˆ‚zâˆ‚z/ 2 * inv(V[3])' * C)'
# âˆ‚zâˆ‚A = âˆ‚wâ¿â»â·â‚ƒâˆ‚wâ¿â»â¸â‚ƒ * âˆ‚zâˆ‚z * âˆ‚zâˆ‚wâ¿â»Â¹ * âˆ‚wâ¿â»Â¹âˆ‚wâ¿â»Â³â‚ * âˆ‚wâ¿â»Â³â‚ƒâˆ‚wâ¿â»â´â‚ƒ * âˆ‚wâ¿â»â´â‚ƒâˆ‚wâ¿â»â¶â‚ƒ * âˆ‚wâ¿â»â¶â‚ƒâˆ‚wâ¿â»â·â‚ƒ  * âˆ‚wâ¿â»â¸â‚ƒâˆ‚wâ¿â»â¹â‚ƒ * (âˆ‚wâ¿â»â¹â‚ƒâˆ‚A + âˆ‚wâ¿â»â¹â‚ƒâˆ‚wâ¿â»Â¹â°â‚ƒ * âˆ‚wâ¿â»Â¹â°â‚ƒâˆ‚A)
# âˆ‚zâˆ‚Aâ‚‚ = -1/2 * C' * inv(C * P_mid[3] * C')' * C * (A * P[3] + A * P[3]')


âˆ‚zâˆ‚A = âˆ‚wâ¿â»Â¹â°â‚‚âˆ‚A + âˆ‚wâ¿â»â¹â‚‚âˆ‚A + âˆ‚wâ¿â»Â¹â°â‚ƒâˆ‚A + âˆ‚wâ¿â»â¹â‚ƒâˆ‚A + âˆ‚wâ¿â»Â¹Â²â‚ƒÂ¹âˆ‚A + âˆ‚wâ¿â»Â¹Â²â‚ƒÂ²âˆ‚A + âˆ‚wâ¿â»Â¹â¶â‚ƒÂ²âˆ‚A + âˆ‚wâ¿â»Â¹â¶â‚ƒÂ³âˆ‚A + âˆ‚wâ¿â»Â²â°â‚ƒÂ²âˆ‚A + âˆ‚wâ¿â»Â²â°â‚ƒÂ³âˆ‚A + âˆ‚wâ¿â»Â¹âµâ‚ƒÂ²âˆ‚A + âˆ‚wâ¿â»Â¹âµâ‚ƒÂ³âˆ‚A # this is correct and captues the effect for all t

zyggrad =   Zygote.gradient(
                x -> begin
                    P_mid2 = x * P[2] * x' + B_prod
                    CP3 = C * P_mid2
                    V3 = CP3 * C'
                    K3 = P_mid2 * C' * inv(V3)
                    P3 = P_mid2 - K3 * CP3

                    P_mid3 = x * P3 * x' + B_prod
                    CP4 = C * P_mid3
                    V4 = CP4 * C'
                    return -1/2*(logdet(V3))
                    # return -1/2*(logdet(V4) + logdet(V3))
                end, 
            A)[1]

isapprox(âˆ‚zâˆ‚Aâ‚‚, zyggrad)
âˆ‚zâˆ‚A - zyggrad

zyggrad =   Zygote.gradient(
                x -> begin
                    P_mid2 = x * P[2] * x' + B_prod
                    CP3 = C * P_mid2
                    V3 = CP3 * C'
                    K3 = P_mid2 * C' * inv(V3)
                    P3 = P_mid2 - K3 * CP3

                    P_mid3 = x * P[3] * x' + B_prod
                    CP4 = C * P_mid3
                    V4 = CP4 * C'
                    return -1/2*logdet(V4)
                end, 
            A)[1]

isapprox(zyggrad, âˆ‚wâ¿â»Â¹â°â‚ƒâˆ‚A + âˆ‚wâ¿â»â¹â‚ƒâˆ‚A)
zyggrad - (âˆ‚wâ¿â»Â¹â°â‚ƒâˆ‚A + âˆ‚wâ¿â»â¹â‚ƒâˆ‚A)


zyggrad =   Zygote.gradient(
                x -> begin
                    P_mid2 = x * P[2] * x' + B_prod
                    # CP3 = C * P_mid2
                    # V3 = CP3 * C'
                    # K3 = P_mid2 * C' * inv(V3)
                    P3 = P_mid2 - K[3] * CP[3]

                    P_mid3 = A * P3 * A' + B_prod
                    CP4 = C * P_mid3
                    V4 = CP4 * C'
                    return -1/2*logdet(V4)
                end, 
            A)[1]

isapprox(zyggrad, âˆ‚wâ¿â»Â¹Â²â‚ƒÂ¹âˆ‚A + âˆ‚wâ¿â»Â¹Â²â‚ƒÂ²âˆ‚A)
zyggrad - (âˆ‚wâ¿â»Â¹Â²â‚ƒÂ¹âˆ‚A + âˆ‚wâ¿â»Â¹Â²â‚ƒÂ²âˆ‚A)
maximum(abs, zyggrad - (âˆ‚wâ¿â»Â¹Â²â‚ƒÂ¹âˆ‚A + âˆ‚wâ¿â»Â¹Â²â‚ƒÂ²âˆ‚A))



zyggrad =   Zygote.gradient(
                x -> begin
                    P_mid2 = x * P[2] * x' + B_prod
                    CP3 = C * P_mid2
                    # V3 = CP3 * C'
                    # K3 = P_mid2 * C' * inv(V3)
                    P3 = P_mid[2] - K[3] * CP3

                    P_mid3 = A * P3 * A' + B_prod
                    CP4 = C * P_mid3
                    V4 = CP4 * C'
                    return -1/2*logdet(V4)
                end, 
            A)[1]





isapprox(fingrad, âˆ‚zâˆ‚A)
fingrad - âˆ‚zâˆ‚A

âˆ‚zâˆ‚A = âˆ‚wâ¿â»Â¹â°â‚ƒâˆ‚A + âˆ‚wâ¿â»â¹â‚ƒâˆ‚A + âˆ‚wâ¿â»Â¹Â²â‚ƒÂ¹âˆ‚A + âˆ‚wâ¿â»Â¹Â²â‚ƒÂ²âˆ‚A

zyggrad = Zygote.gradient(x -> -1/2*logdet(C * (x * (P[3] - P[3] * C' * invV[4] * C * P[3]) * x' + ğ) * C'), A)[1]

zyggrad =   Zygote.gradient(
                x -> begin
                    P_mid2 = x * P[2] * x' + B_prod
                    CP3 = C * P_mid2
                    V3 = CP3 * C'
                    K3 = P_mid2 * C' * inv(V3)
                    P3 = P_mid2 - K3 * CP3

                    P_mid3 = x * P3 * x' + B_prod
                    CP4 = C * P_mid3
                    V4 = CP4 * C'
                    return -1/2*logdet(V4)
                end, 
            A)[1]

isapprox(âˆ‚zâˆ‚A, zyggrad)

fingrad = FiniteDifferences.grad(FiniteDifferences.central_fdm(4,1),
x -> begin
P_mid[1] = deepcopy(PP)
P[1] = deepcopy(PP)
loglik = 0.0
for t in 2:4
    CP[t] .= C * P_mid[t-1]

    V[t] .= CP[t] * C'

    luV = â„’.lu(V[t], check = false)

    Vdet = â„’.det(luV)
    
    invV[t] .= inv(luV)
    
    innovation[t] .= observables[:, t-1] - z[t-1]
    if t == 4
    loglik += log(Vdet)# + innovation[t]' * invV[t] * innovation[t]
    end
    K[t] .= P_mid[t-1] * C' * invV[t]

    u[t] .= K[t] * innovation[t] + u_mid[t-1]
    
    P[t] .= P_mid[t-1] - K[t] * CP[t]

    u_mid[t] .= A * u[t]

    z[t] .= C * u_mid[t]

    P_mid[t] .= x * P[t] * x' + B_prod
end
return -1/2*loglik
end, A)[1]


isapprox(fingrad, zyggrad)

fingrad - âˆ‚zâˆ‚A
# wâ¿â»Â¹Â³â‚ƒ = K[3] * CP[3] = wâ¿â»Â¹â´â‚ƒ * wâ¿â»Â¹âµâ‚ƒ
âˆ‚wâ¿â»Â¹Â³â‚ƒâˆ‚wâ¿â»Â¹â´â‚ƒ = âˆ‚wâ¿â»Â¹Â¹â‚ƒâˆ‚wâ¿â»Â¹Â³â‚ƒ * CP[3]'
âˆ‚wâ¿â»Â¹Â³â‚ƒâˆ‚wâ¿â»Â¹âµâ‚ƒ = K[3]' * âˆ‚wâ¿â»Â¹Â¹â‚ƒâˆ‚wâ¿â»Â¹Â³â‚ƒ


# wâ¿â»Â¹â´â‚ƒ = K[3] = PC[2] * invV[3] = P_mid[2] * C' * invV[3] = wâ¿â»Â¹â¶â‚ƒ * wâ¿â»Â¹â·â‚ƒ
âˆ‚wâ¿â»Â¹â´â‚ƒâˆ‚wâ¿â»Â¹â¶â‚ƒ = âˆ‚wâ¿â»Â¹Â³â‚ƒâˆ‚wâ¿â»Â¹â´â‚ƒ * invV[3]'
âˆ‚wâ¿â»Â¹â´â‚ƒâˆ‚wâ¿â»Â¹â·â‚ƒ = (P_mid[2] * C')' * âˆ‚wâ¿â»Â¹Â³â‚ƒâˆ‚wâ¿â»Â¹â´â‚ƒ

wâ¿â»Â¹â¶â‚ƒ = P_mid[2] * C'
âˆ‚wâ¿â»Â¹â¶â‚ƒâˆ‚P = âˆ‚wâ¿â»Â¹â´â‚ƒâˆ‚wâ¿â»Â¹â¶â‚ƒ * C

# wâ¿â»Â¹â·â‚ƒ = inv(V[3]) = inv(wâ¿â»Â¹â¸â‚ƒ)
âˆ‚wâ¿â»Â¹â·â‚ƒâˆ‚wâ¿â»Â¹â¸â‚ƒ = -invV[3]' * âˆ‚wâ¿â»Â¹â´â‚ƒâˆ‚wâ¿â»Â¹â·â‚ƒ * invV[3]'

# wâ¿â»Â¹â¸â‚ƒ = V[3] = CP[3] * C' = wâ¿â»Â¹â¹â‚ƒ * C' = wâ¿â»â¶â‚
# wâ¿â»Â¹â¹â‚ƒ = CP[3] = C * P_mid[2] = 
âˆ‚wâ¿â»Â¹â¸â‚ƒâˆ‚wâ¿â»Â¹â¹â‚ƒ = âˆ‚wâ¿â»Â¹â·â‚ƒâˆ‚wâ¿â»Â¹â¸â‚ƒ * C
âˆ‚wâ¿â»Â¹â¹â‚ƒâˆ‚P = C' * âˆ‚wâ¿â»Â¹â¸â‚ƒâˆ‚wâ¿â»Â¹â¹â‚ƒ


# wâ¿â»Â¹â¹â‚ƒ = wâ¿â»Â¹âµâ‚ƒ
âˆ‚wâ¿â»Â¹âµâ‚ƒâˆ‚P = C' * âˆ‚wâ¿â»Â¹Â³â‚ƒâˆ‚wâ¿â»Â¹âµâ‚ƒ


âˆ‚zâˆ‚P = âˆ‚wâ¿â»Â¹âµâ‚ƒâˆ‚P + âˆ‚wâ¿â»Â¹â¹â‚ƒâˆ‚P + âˆ‚wâ¿â»Â¹â¶â‚ƒâˆ‚P + âˆ‚wâ¿â»Â¹Â¹â‚ƒâˆ‚P + âˆ‚wâ¿â»â·â‚âˆ‚P
