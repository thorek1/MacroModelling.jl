using Revise
using MacroModelling

# include("../test/models/RBC_CME_calibration_equations_and_parameter_definitions_and_specfuns.jl")
# ğ“‚ = m

# include("../models/Smets_Wouters_2003.jl")
# ğ“‚ = Smets_Wouters_2003

include("../models/Smets_Wouters_2007.jl")
ğ“‚ = Smets_Wouters_2007

stst = SS(ğ“‚, derivatives = false)
sum(abs,stst) # 153.25700896899727
get_solution(ğ“‚)

sum(abs,ğ“‚.jacobian[1]) # 3727.9291798016457
# RBC_CME_calibration_equations_and_parameter_definitions_and_specfuns 40.19955622201187
ğ“‚.jacobian[1][13,:]

ğ“‚.jacobian[1].nzval[72]

ğ”™ = ğ“‚.solution.non_stochastic_steady_state
ğ”“ = ğ“‚.parameter_values


import MacroModelling: get_symbols, match_pattern, replace_symbols
using Symbolics


    future_varss  = collect(reduce(union,match_pattern.(get_symbols.(ğ“‚.dyn_equations),r"â‚â‚â‚$")))
    present_varss = collect(reduce(union,match_pattern.(get_symbols.(ğ“‚.dyn_equations),r"â‚â‚€â‚$")))
    past_varss    = collect(reduce(union,match_pattern.(get_symbols.(ğ“‚.dyn_equations),r"â‚â‚‹â‚â‚$")))
    shock_varss   = collect(reduce(union,match_pattern.(get_symbols.(ğ“‚.dyn_equations),r"â‚â‚“â‚$")))
    ss_varss      = collect(reduce(union,match_pattern.(get_symbols.(ğ“‚.dyn_equations),r"â‚â‚›â‚›â‚$")))

    sort!(future_varss  ,by = x->replace(string(x),r"â‚â‚â‚$"=>"")) #sort by name without time index because otherwise eps_zá´¸â½â»Â¹â¾â‚â‚‹â‚â‚ comes before eps_zâ‚â‚‹â‚â‚
    sort!(present_varss ,by = x->replace(string(x),r"â‚â‚€â‚$"=>""))
    sort!(past_varss    ,by = x->replace(string(x),r"â‚â‚‹â‚â‚$"=>""))
    sort!(shock_varss   ,by = x->replace(string(x),r"â‚â‚“â‚$"=>""))
    sort!(ss_varss      ,by = x->replace(string(x),r"â‚â‚›â‚›â‚$"=>""))

    dyn_future_list = collect(reduce(union, ğ“‚.dyn_future_list))
    dyn_present_list = collect(reduce(union, ğ“‚.dyn_present_list))
    dyn_past_list = collect(reduce(union, ğ“‚.dyn_past_list))
    dyn_exo_list = collect(reduce(union,ğ“‚.dyn_exo_list))
    dyn_ss_list = Symbol.(string.(collect(reduce(union,ğ“‚.dyn_ss_list))) .* "â‚â‚›â‚›â‚")

    future = map(x -> Symbol(replace(string(x), r"â‚â‚â‚" => "")),string.(dyn_future_list))
    present = map(x -> Symbol(replace(string(x), r"â‚â‚€â‚" => "")),string.(dyn_present_list))
    past = map(x -> Symbol(replace(string(x), r"â‚â‚‹â‚â‚" => "")),string.(dyn_past_list))
    exo = map(x -> Symbol(replace(string(x), r"â‚â‚“â‚" => "")),string.(dyn_exo_list))
    stst = map(x -> Symbol(replace(string(x), r"â‚â‚›â‚›â‚" => "")),string.(dyn_ss_list))

    vars_raw = vcat(dyn_future_list[indexin(sort(future),future)],
                    dyn_present_list[indexin(sort(present),present)],
                    dyn_past_list[indexin(sort(past),past)],
                    dyn_exo_list[indexin(sort(exo),exo)])

    dyn_var_future_idx = ğ“‚.solution.perturbation.auxiliary_indices.dyn_var_future_idx
    dyn_var_present_idx = ğ“‚.solution.perturbation.auxiliary_indices.dyn_var_present_idx
    dyn_var_past_idx = ğ“‚.solution.perturbation.auxiliary_indices.dyn_var_past_idx
    dyn_ss_idx = ğ“‚.solution.perturbation.auxiliary_indices.dyn_ss_idx

    dyn_var_idxs = vcat(dyn_var_future_idx, dyn_var_present_idx, dyn_var_past_idx)

    pars_ext = vcat(ğ“‚.parameters, ğ“‚.calibration_equations_parameters)
    parameters_and_SS = vcat(pars_ext, dyn_ss_list[indexin(sort(stst),stst)])

    np = length(parameters_and_SS)
    nv = length(vars_raw)
    nc = length(ğ“‚.calibration_equations)
    nps = length(ğ“‚.parameters)
    nxs = maximum(dyn_var_idxs) + nc


Symbolics.@variables ğ”“[1:np] ğ”™[1:nv]



    parameter_dict = Dict{Symbol, Symbol}()
    back_to_array_dict = Dict{Symbolics.Num, Symbolics.Num}()
    calib_vars = Symbol[]
    calib_expr = []
    SS_mapping = Dict{Symbolics.Num, Symbolics.Num}()


    for (i,v) in enumerate(parameters_and_SS)
        push!(parameter_dict, v => :($(Symbol("ğ”“_$i"))))
        push!(back_to_array_dict, Symbolics.parse_expr_to_symbolic(:($(Symbol("ğ”“_$i"))), @__MODULE__) => ğ”“[i])
        if i > nps
            if i > length(pars_ext)
                push!(SS_mapping, ğ”“[i] => ğ”™[dyn_ss_idx[i-length(pars_ext)]])
            else
                push!(SS_mapping, ğ”“[i] => ğ”™[nxs + i - nps - nc])
            end
        end
    end

    for (i,v) in enumerate(vars_raw)
        push!(parameter_dict, v => :($(Symbol("ğ”™_$i"))))
        push!(back_to_array_dict, Symbolics.parse_expr_to_symbolic(:($(Symbol("ğ”™_$i"))), @__MODULE__) => ğ”™[i])
        if i <= length(dyn_var_idxs)
            push!(SS_mapping, ğ”™[i] => ğ”™[dyn_var_idxs[i]])
        else
            push!(SS_mapping, ğ”™[i] => 0)
        end
    end


    for v in ğ“‚.calibration_equations_no_var
        push!(calib_vars, v.args[1])
        push!(calib_expr, v.args[2])
    end


    calib_replacements = Dict{Symbol,Any}()
    for (i,x) in enumerate(calib_vars)
        replacement = Dict(x => calib_expr[i])
        for ii in i+1:length(calib_vars)
            calib_expr[ii] = replace_symbols(calib_expr[ii], replacement)
        end
        push!(calib_replacements, x => calib_expr[i])
    end

ğ“‚.dyn_equations[[13]] |> 
        x -> replace_symbols.(x, Ref(calib_replacements)) |> 
        x -> replace_symbols.(x, Ref(parameter_dict)) |> 
        x -> Symbolics.parse_expr_to_symbolic.(x, Ref(@__MODULE__)) |>
        x -> Symbolics.substitute.(x, Ref(back_to_array_dict))

        
expr_to_parse = :(ğ”™_82 - exp(((ğ”“_7 - 1) / (1 + ğ”“_13)) * ((ğ”™_57 * ((ğ”“_5 * (1 - ğ”“_2)) / ğ”“_2 + ğ”™_78)) / (1 + (ğ”“_5 * (1 - ğ”“_2)) / ğ”“_2)) ^ (1 + ğ”“_13)) * (ğ”™_34 - (ğ”™_91 * ğ”“_11) / (1 + ğ”“_34 / 100)) ^ -ğ”“_7)

Symbolics.parse_expr_to_symbolic(expr_to_parse, @__MODULE__)

dyn_equations = Symbolics.Num[(-ğ”™[100]*ğ”™[29]) / (1 + ğ”“[34] / 100) - ğ”™[34] - ğ”™[51] + ğ”™[84] - ğ”“[49]*ğ”™[50], (((ğ”“[4]*(1 - ğ”“[8])) / ğ”“[8] + ğ”™[62])*ğ”™[84]) / (1 + (ğ”“[4]*(1 - ğ”“[8])) / ğ”“[8]) + ğ”“[49]*(-1 + ğ”“[8]) - (ğ”™[57]^(1 - ğ”“[6]))*(ğ”™[53]^ğ”“[6])*ğ”™[28], (-ğ”™[100]*ğ”™[87]) / (1 + ğ”“[34] / 100) + ğ”™[53], (-(1 - ğ”“[1])*ğ”™[100]) / (1 + ğ”“[34] / 100) + ğ”™[55] - (1 - ğ”™[24])*ğ”™[51]*ğ”™[68], (-(ğ”™[23]^((-(1 + (ğ”“[4]*(1 - ğ”“[8])) / ğ”“[8])*ğ”“[8]) / (-1 + ğ”“[8])))*(1 - ğ”“[14])) / (ğ”™[38]^((-(1 + (ğ”“[4]*(1 - ğ”“[8])) / ğ”“[8])*ğ”“[8]) / (-1 + ğ”“[8]))) + (-(((ğ”™[105]^ğ”“[16])*(ğ”“[43]^(1 - ğ”“[16]))*ğ”™[93])^((-(1 + (ğ”“[4]*(1 - ğ”“[8])) / ğ”“[8])*ğ”“[8]) / (-1 + ğ”“[8])))*ğ”“[14]*ğ”™[103]) / ((ğ”™[38]*ğ”™[64])^((-(1 + (ğ”“[4]*(1 - ğ”“[8])) / ğ”“[8])*ğ”“[8]) / (-1 + ğ”“[8]))) + ğ”™[62], (-(((ğ”“[43]^(1 - ğ”“[15]))*(ğ”™[105]^ğ”“[15])*ğ”™[94])^((-(1 + ((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2])*ğ”“[2]) / (-1 + ğ”“[2])))*ğ”“[12]*ğ”™[111]) / ((ğ”™[39]*ğ”™[64])^((-(1 + ((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2])*ğ”“[2]) / (-1 + ğ”“[2]))) + (-(ğ”™[81]^((-(1 + ((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2])*ğ”“[2]) / (-1 + ğ”“[2])))*(1 - ğ”“[12])) / (ğ”™[39]^((-(1 + ((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2])*ğ”“[2]) / (-1 + ğ”“[2]))) + ğ”™[78], 1 + (-(((ğ”™[105]^ğ”“[16])*(ğ”“[43]^(1 - ğ”“[16]))*ğ”™[93])^((-1 - ğ”“[4]*(1 - ğ”“[8])) / (-1 + ğ”“[8])))*ğ”“[14]) / ((ğ”™[38]*ğ”™[64])^((-1 - ğ”“[4]*(1 - ğ”“[8])) / (-1 + ğ”“[8]))) + (-(ğ”™[23]^((-1 - ğ”“[4]*(1 - ğ”“[8])) / (-1 + ğ”“[8])))*(1 - ğ”“[14])) / (ğ”™[38]^((-1 - ğ”“[4]*(1 - ğ”“[8])) / (-1 + ğ”“[8]))), 1 + (-(ğ”™[81]^((-1 - (1 - ğ”“[2])*ğ”“[5]) / (-1 + ğ”“[2])))*(1 - ğ”“[12])) / (ğ”™[39]^((-1 - (1 - ğ”“[2])*ğ”“[5]) / (-1 + ğ”“[2]))) + (-(((ğ”“[43]^(1 - ğ”“[15]))*(ğ”™[105]^ğ”“[15])*ğ”™[94])^((-1 - (1 - ğ”“[2])*ğ”“[5]) / (-1 + ğ”“[2])))*ğ”“[12]) / ((ğ”™[39]*ğ”™[64])^((-1 - (1 - ğ”“[2])*ğ”“[5]) / (-1 + ğ”“[2]))), 1 + (-(1 + (ğ”“[4]*(1 - ğ”“[8])*ğ”™[63]) / ğ”“[8])*ğ”™[38]) / (1 + (ğ”“[4]*(1 - ğ”“[8])) / ğ”“[8]), (-(1 + ((1 - ğ”“[2])*ğ”“[5]*ğ”™[79]) / ğ”“[2])*ğ”™[39]) / (1 + ((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2]) + ğ”™[77], (-(1 - ğ”“[14])*ğ”™[23]) / ğ”™[38] + (-(ğ”™[105]^ğ”“[16])*(ğ”“[43]^(1 - ğ”“[16]))*ğ”“[14]*ğ”™[104]*ğ”™[93]) / (ğ”™[38]*ğ”™[64]) + ğ”™[63], (-(1 - ğ”“[12])*ğ”™[81]) / ğ”™[39] + (-(ğ”“[43]^(1 - ğ”“[15]))*(ğ”™[105]^ğ”“[15])*ğ”“[12]*ğ”™[112]*ğ”™[94]) / (ğ”™[39]*ğ”™[64]) + ğ”™[79], ğ”™[82] - exp(((((((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2] + ğ”™[78])*ğ”™[57])^(1 + ğ”“[13]))*(-1 + ğ”“[7])) / (((1 + ((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2])^(1 + ğ”“[13]))*(1 + ğ”“[13])))*(((-ğ”“[11]*ğ”™[91]) / (1 + ğ”“[34] / 100) + ğ”™[34])^(-ğ”“[7])), 1 + (-((1 + ğ”“[34] / 100)^(-ğ”“[7]))*((1 + ğ”“[34] / 100)^2)*ğ”™[1]*(ğ”™[11]^2)*ğ”™[14]*ğ”™[19]*ğ”™[69]) / ((1 + ğ”“[33] / 100)*(ğ”™[51]^2)*ğ”™[82]) - (1 + (-(1 + ğ”“[34] / 100)*ğ”™[25]*ğ”™[51]) / ğ”™[98] - ğ”™[24])*ğ”™[66]*ğ”™[68], (-((1 + ğ”“[34] / 100)^(-ğ”“[7]))*ğ”™[19]*ğ”™[33]*ğ”™[70]) / ((1 + ğ”“[33] / 100)*ğ”™[13]) + ğ”™[82], -ğ”™[30] + ğ”™[71], (-((1 + ğ”“[34] / 100)^(-ğ”“[7]))*(-ğ”™[3] + (1 - ğ”“[1])*ğ”™[14] + ğ”™[17]*ğ”™[21])*ğ”™[19]) / ((1 + ğ”“[33] / 100)*ğ”™[82]) + ğ”™[66], (-ğ”“[6]*ğ”™[57]*ğ”™[77]) / ((1 - ğ”“[6])*ğ”™[71]) + ğ”™[53], (-(ğ”™[71]^ğ”“[6])*(ğ”™[77]^(1 - ğ”“[6]))) / ((ğ”“[6]^ğ”“[6])*((1 - ğ”“[6])^(1 - ğ”“[6]))*ğ”™[28]) + ğ”™[60], (-(ğ”™[81]^(1 + ((1 + ((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2])*ğ”“[2]) / (-1 + ğ”“[2])))*(-1 + ğ”“[2])*(1 - ğ”“[2])*ğ”“[5]*ğ”™[49]) / ((1 + ((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2])*ğ”“[2]) + ((1 + (1 - ğ”“[2])*ğ”“[5])*ğ”™[47]*ğ”™[81]) / (1 + ((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2]) - ğ”“[2]*ğ”™[48], (-((1 + ğ”“[34] / 100)^(-ğ”“[7]))*(((ğ”™[64]^ğ”“[15])*(ğ”“[43]^(1 - ğ”“[15])))^((-1 - (1 - ğ”“[2])*ğ”“[5]) / (-1 + ğ”“[2])))*ğ”“[12]*(1 + ğ”“[34] / 100)*ğ”™[19]*ğ”™[8]) / ((ğ”™[13]^((-1 - (1 - ğ”“[2])*ğ”“[5]) / (-1 + ğ”“[2])))*(1 + ğ”“[33] / 100)*ğ”™[82]) + ğ”™[47] - (ğ”™[39]^(((1 + ((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2])*ğ”“[2]) / (-1 + ğ”“[2])))*ğ”™[57], (-(((ğ”™[64]^ğ”“[15])*(ğ”“[43]^(1 - ğ”“[15])))^((-(1 + ((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2])*ğ”“[2]) / (-1 + ğ”“[2])))*((1 + ğ”“[34] / 100)^(-ğ”“[7]))*ğ”“[12]*(1 + ğ”“[34] / 100)*ğ”™[19]*ğ”™[9]) / ((ğ”™[13]^((-(1 + ((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2])*ğ”“[2]) / (-1 + ğ”“[2])))*(1 + ğ”“[33] / 100)*ğ”™[82]) + (-((-ğ”“[11]*ğ”™[91]) / (1 + ğ”“[34] / 100) + ğ”™[34])*(((((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2] + ğ”™[78])*ğ”™[57])^ğ”“[13])*(ğ”™[39]^(((1 + ((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2])*ğ”“[2]) / (-1 + ğ”“[2])))*ğ”™[57]*ğ”™[76]) / ((1 + ((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2])^ğ”“[13]) + ğ”™[48], (-(ğ”™[64]^ğ”“[15])*(ğ”“[43]^(1 - ğ”“[15]))*((1 + ğ”“[34] / 100)^(-ğ”“[7]))*ğ”“[12]*(1 + ğ”“[34] / 100)*ğ”™[10]*ğ”™[19]) / ((1 + ğ”“[33] / 100)*ğ”™[13]*ğ”™[82]) + ğ”™[49] - ğ”™[57], (-(ğ”™[23]^(1 + ((1 + (ğ”“[4]*(1 - ğ”“[8])) / ğ”“[8])*ğ”“[8]) / (-1 + ğ”“[8])))*ğ”“[4]*(-1 + ğ”“[8])*(1 - ğ”“[8])*ğ”™[46]) / ((1 + (ğ”“[4]*(1 - ğ”“[8])) / ğ”“[8])*ğ”“[8]) + ((1 + ğ”“[4]*(1 - ğ”“[8]))*ğ”™[23]*ğ”™[44]) / (1 + (ğ”“[4]*(1 - ğ”“[8])) / ğ”“[8]) - ğ”“[8]*ğ”™[45], (-(((ğ”™[64]^ğ”“[16])*(ğ”“[43]^(1 - ğ”“[16])))^((-1 - ğ”“[4]*(1 - ğ”“[8])) / (-1 + ğ”“[8])))*((1 + ğ”“[34] / 100)^(-ğ”“[7]))*ğ”“[14]*(1 + ğ”“[34] / 100)*ğ”™[19]*ğ”™[5]) / ((ğ”™[13]^((-1 - ğ”“[4]*(1 - ğ”“[8])) / (-1 + ğ”“[8])))*(1 + ğ”“[33] / 100)*ğ”™[82]) + ğ”™[44] - (ğ”™[38]^(((1 + (ğ”“[4]*(1 - ğ”“[8])) / ğ”“[8])*ğ”“[8]) / (-1 + ğ”“[8])))*ğ”™[84], (-(((ğ”™[64]^ğ”“[16])*(ğ”“[43]^(1 - ğ”“[16])))^((-(1 + (ğ”“[4]*(1 - ğ”“[8])) / ğ”“[8])*ğ”“[8]) / (-1 + ğ”“[8])))*((1 + ğ”“[34] / 100)^(-ğ”“[7]))*ğ”“[14]*(1 + ğ”“[34] / 100)*ğ”™[19]*ğ”™[6]) / ((ğ”™[13]^((-(1 + (ğ”“[4]*(1 - ğ”“[8])) / ğ”“[8])*ğ”“[8]) / (-1 + ğ”“[8])))*(1 + ğ”“[33] / 100)*ğ”™[82]) + ğ”™[45] - (ğ”™[38]^(((1 + (ğ”“[4]*(1 - ğ”“[8])) / ğ”“[8])*ğ”“[8]) / (-1 + ğ”“[8])))*ğ”™[60]*ğ”™[75]*ğ”™[84], (-(ğ”™[64]^ğ”“[16])*(ğ”“[43]^(1 - ğ”“[16]))*((1 + ğ”“[34] / 100)^(-ğ”“[7]))*ğ”“[14]*(1 + ğ”“[34] / 100)*ğ”™[19]*ğ”™[7]) / ((1 + ğ”“[33] / 100)*ğ”™[13]*ğ”™[82]) + ğ”™[46] - ğ”™[84], -ğ”™[16] + ğ”™[69], (-(ğ”™[84]^((1 - ğ”“[19])*ğ”“[20]))*(ğ”™[107]^ğ”“[19])*((ğ”™[114]*ğ”™[84])^ğ”“[21])*(ğ”™[64]^(ğ”“[18]*(1 - ğ”“[19])))*(ğ”“[45]^(1 - ğ”“[19]))*ğ”™[61]) / ((ğ”“[43]^(ğ”“[18]*(1 - ğ”“[19])))*(ğ”™[85]^((1 - ğ”“[19])*ğ”“[20]))*((ğ”™[113]*ğ”™[85])^ğ”“[21])) + ğ”™[70], (-(-1 + exp((ğ”“[17]*(-1 + ğ”™[87])) / (1 - ğ”“[17])))*(1 - ğ”“[17])*ğ”“[46]) / ğ”“[17] + ğ”™[29], ğ”™[30] - exp((ğ”“[17]*(-1 + ğ”™[87])) / (1 - ğ”“[17]))*ğ”“[46], ğ”™[24] - (1//2)*((-1 + ((1 + ğ”“[34] / 100)*ğ”™[51]) / ğ”™[98] - (1//100)*ğ”“[34])^2)*ğ”“[10], ğ”™[25] - (-1 + ((1 + ğ”“[34] / 100)*ğ”™[51]) / ğ”™[98] - (1//100)*ğ”“[34])*ğ”“[10], -1 + ğ”“[22] + ğ”™[28] - ğ”“[22]*ğ”™[89] - (1//100)*ğ”“[35]*ğ”™[115], -1 + ((1 + ğ”“[11] / (1 + ğ”“[34] / 100))*ğ”“[36]*ğ”“[7]*ğ”™[116]) / (100(1 + (-ğ”“[11]) / (1 + ğ”“[34] / 100))) + ğ”“[23] + ğ”™[33] - ğ”“[23]*ğ”™[90], -ğ”“[3] + ğ”™[50] - ğ”“[24]*(-ğ”“[3] + ğ”™[97]) - (1//100)*ğ”“[37]*ğ”™[117] - (1//100)*ğ”“[35]*ğ”“[9]*ğ”™[115], -1 + ğ”“[25] + ğ”™[68] - ğ”“[25]*ğ”™[106] - (1//100)*(1 + ((1 + ğ”“[34] / 100)^(1 - ğ”“[7])) / (1 + ğ”“[33] / 100))*ğ”“[10]*((1 + ğ”“[34] / 100)^2)*ğ”“[40]*ğ”™[120], -1 + ğ”“[26] + ğ”™[61] - ğ”“[26]*ğ”™[102] - (1//100)*ğ”“[38]*ğ”™[118], -1 + ğ”“[27] - ğ”™[42] + ğ”™[75] - ğ”“[27]*ğ”™[108] + ğ”“[29]*ğ”™[95], (-(1 + (((1 + ğ”“[34] / 100)^(-ğ”“[7]))*ğ”“[16]*(1 + ğ”“[34] / 100)) / (1 + ğ”“[33] / 100))*ğ”“[14]*(1 + ğ”“[4]*(-1 + ğ”“[8]))*ğ”“[41]*ğ”™[119]) / (100(1 + (-((1 + ğ”“[34] / 100)^(-ğ”“[7]))*ğ”“[14]*(1 + ğ”“[34] / 100)) / (1 + ğ”“[33] / 100))*(1 - ğ”“[14])) + ğ”™[42], -1 + ğ”“[28] - ğ”™[43] + ğ”™[76] - ğ”“[28]*ğ”™[109] + ğ”“[30]*ğ”™[96], (-(1 + (((1 + ğ”“[34] / 100)^(-ğ”“[7]))*(1 + ğ”“[34] / 100)) / (1 + ğ”“[33] / 100))*ğ”“[12]*(1 + (-1 + ğ”“[2])*ğ”“[5])*ğ”“[39]*ğ”™[121]) / (100(1 + (-((1 + ğ”“[34] / 100)^(-ğ”“[7]))*ğ”“[12]*(1 + ğ”“[34] / 100)) / (1 + ğ”“[33] / 100))*(1 - ğ”“[12])) + ğ”™[43], (-ğ”™[101]*ğ”™[32]) / (1 + ğ”“[34] / 100) - ğ”™[35] - ğ”™[52] + ğ”™[85] - ğ”“[50]*ğ”™[50], ğ”™[85] + ğ”“[50]*(-1 + ğ”“[8]) - (ğ”™[58]^(1 - ğ”“[6]))*(ğ”™[54]^ğ”“[6])*ğ”™[28], (-ğ”™[101]*ğ”™[88]) / (1 + ğ”“[34] / 100) + ğ”™[54], (-(1 - ğ”“[1])*ğ”™[101]) / (1 + ğ”“[34] / 100) + ğ”™[56] - (1 - ğ”™[27])*ğ”™[52]*ğ”™[68], ğ”™[83] - (((-ğ”“[11]*ğ”™[92]) / (1 + ğ”“[34] / 100) + ğ”™[35])^(-ğ”“[7]))*exp(((ğ”™[58]^(1 + ğ”“[13]))*(-1 + ğ”“[7])) / (1 + ğ”“[13])), 1 + (-((1 + ğ”“[34] / 100)^(-ğ”“[7]))*((1 + ğ”“[34] / 100)^2)*(ğ”™[12]^2)*ğ”™[15]*ğ”™[2]*ğ”™[20]*ğ”™[69]) / ((1 + ğ”“[33] / 100)*(ğ”™[52]^2)*ğ”™[83]) - (1 + (-(1 + ğ”“[34] / 100)*ğ”™[26]*ğ”™[52]) / ğ”™[99] - ğ”™[27])*ğ”™[67]*ğ”™[68], (-((1 + ğ”“[34] / 100)^(-ğ”“[7]))*ğ”™[20]*ğ”™[33]*ğ”™[74]) / (1 + ğ”“[33] / 100) + ğ”™[83], -ğ”™[31] + ğ”™[72], (-((1 + ğ”“[34] / 100)^(-ğ”“[7]))*(-ğ”™[4] + (1 - ğ”“[1])*ğ”™[15] + ğ”™[18]*ğ”™[22])*ğ”™[20]) / ((1 + ğ”“[33] / 100)*ğ”™[83]) + ğ”™[67], (-ğ”“[6]*ğ”™[58]*ğ”™[80]) / ((1 - ğ”“[6])*ğ”™[72]) + ğ”™[54], (-(ğ”™[80]^(1 - ğ”“[6]))*(ğ”™[72]^ğ”“[6])) / ((ğ”“[6]^ğ”“[6])*((1 - ğ”“[6])^(1 - ğ”“[6]))*ğ”™[28]) + ğ”“[42], ((1 + (1 - ğ”“[2])*ğ”“[5])*ğ”™[80]) / (1 + ((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2]) - (((-1 + ğ”“[2])*(1 - ğ”“[2])*ğ”“[5]*ğ”™[80]) / ((1 + ((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2])*ğ”“[2]) + (ğ”™[58]^ğ”“[13])*((-ğ”“[11]*ğ”™[92]) / (1 + ğ”“[34] / 100) + ğ”™[35])*ğ”“[2])*ğ”“[48], (-(-1 + exp((ğ”“[17]*(-1 + ğ”™[88])) / (1 - ğ”“[17])))*(1 - ğ”“[17])*ğ”“[47]) / ğ”“[17] + ğ”™[32], ğ”™[31] - exp((ğ”“[17]*(-1 + ğ”™[88])) / (1 - ğ”“[17]))*ğ”“[47], ğ”™[27] - (1//2)*((-1 + ((1 + ğ”“[34] / 100)*ğ”™[52]) / ğ”™[99] - (1//100)*ğ”“[34])^2)*ğ”“[10], ğ”™[26] - (-1 + ((1 + ğ”“[34] / 100)*ğ”™[52]) / ğ”™[99] - (1//100)*ğ”“[34])*ğ”“[10], -100log(ğ”™[84] / ğ”™[85]) + ğ”™[86], -100(-1 + ğ”™[84] / ğ”™[113]) - ğ”“[34] + ğ”™[41], -100(-1 + ğ”™[34] / ğ”™[91]) - ğ”“[34] + ğ”™[36], -100(-1 + ğ”™[51] / ğ”™[98]) - ğ”“[34] + ğ”™[37], -100(-1 + ğ”™[64]) + ğ”™[65], -100(-1 + ğ”™[70]) + ğ”™[73], -100(-1 + ğ”™[77] / ğ”™[110]) - ğ”“[34] + ğ”™[40], -100(-1 + ğ”™[57] / ğ”“[44]) - ğ”“[31] + ğ”™[59]]

# eq 13:  ğ”™[82] - exp(((((((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2] + ğ”™[78])*ğ”™[57])^(1 + ğ”“[13]))*(-1 + ğ”“[7])) / (((1 + ((1 - ğ”“[2])*ğ”“[5]) / ğ”“[2])^(1 + ğ”“[13]))*(1 + ğ”“[13])))*(((-ğ”“[11]*ğ”™[91]) / (1 + ğ”“[34] / 100) + ğ”™[34])^(-ğ”“[7]))
spX_order_1 = Symbolics.sparsejacobian(dyn_equations[[13]], ğ”™) # nÏµ x nx
spX_order_1.nzval

((1 - ğ”“[2]) * ğ”“[5] / ğ”“[2] + ğ”™[56]) * ğ”™[35]

(+)(1, (getindex)(ğ”“, 13))


(*)((*)((^)((+)((/)((*)((*)(-1, (getindex)(ğ”“, 11)), (getindex)(ğ”™, 12)), (+)(1, (/)((getindex)(ğ”“, 34), 100))), (getindex)(ğ”™, 12)), (+)(-1, (*)(-1, (getindex)(ğ”“, 7)))), (exp)((/)((*)((^)((*)((+)((/)((*)((+)(1, (*)(-1, (getindex)(ğ”“, 2))), (getindex)(ğ”“, 5)), (getindex)(ğ”“, 2)), (getindex)(ğ”™, 56)), (getindex)(ğ”™, 35)), (+)(1, (getindex)(ğ”“, 13))), (+)(-1, (getindex)(ğ”“, 7))), (*)((^)((+)(1, (/)((*)((+)(1, (*)(-1, (getindex)(ğ”“, 2))), (getindex)(ğ”“, 5)), (getindex)(ğ”“, 2))), (+)(1, (getindex)(ğ”“, 13))), (+)(1, (getindex)(ğ”“, 13)))))), (getindex)(ğ”“, 7))

using NaNMath
(*)((*)((^)((+)((/)((*)((*)(-1, (getindex)(ğ”“, 11)), (getindex)(ğ”™, 12)), (+)(1, (/)((getindex)(ğ”“, 34), 100))), (getindex)(ğ”™, 12)), (+)(-1, (*)(-1, (getindex)(ğ”“, 7)))), (exp)((/)((*)((^)((*)((+)((/)((*)((+)(1, (*)(-1, (getindex)(ğ”“, 2))), (getindex)(ğ”“, 5)), (getindex)(ğ”“, 2)), (getindex)(ğ”™, 56)), (getindex)(ğ”™, 35)), (+)(1, (getindex)(ğ”“, 13))), (+)(-1, (getindex)(ğ”“, 7))), (*)((^)((+)(1, (/)((*)((+)(1, (*)(-1, (getindex)(ğ”“, 2))), (getindex)(ğ”“, 5)), (getindex)(ğ”“, 2))), (+)(1, (getindex)(ğ”“, 13))), (+)(1, (getindex)(ğ”“, 13)))))), (getindex)(ğ”“, 7))

(/)((*)((*)((*)((*)(-1, (^)((getindex)(ğ”™, 17), (/)((*)((+)(1, (/)((*)((+)(1, (*)(-1, (getindex)(ğ”“, 2))), (getindex)(ğ”“, 5)), (getindex)(ğ”“, 2))), (getindex)(ğ”“, 2)), (+)(-1, (getindex)(ğ”“, 2))))), (^)((*)((+)((/)((*)((+)(1, (*)(-1, (getindex)(ğ”“, 2))), (getindex)(ğ”“, 5)), (getindex)(ğ”“, 2)), (getindex)(ğ”™, 56)), (getindex)(ğ”™, 35)), (getindex)(ğ”“, 13))), (getindex)(ğ”™, 35)), (getindex)(ğ”™, 54)), (^)((+)(1, (/)((*)((+)(1, (*)(-1, (getindex)(ğ”“, 2))), (getindex)(ğ”“, 5)), (getindex)(ğ”“, 2))), (getindex)(ğ”“, 13)))



(*)((*)((exp)((/)((*)((^)((/)((*)((+)((/)((*)((+)(1, (*)(-1, (getindex)(ğ”“, 2))), (getindex)(ğ”“, 5)), (getindex)(ğ”“, 2)), (getindex)(ğ”™, 56)), (getindex)(ğ”™, 35)), (+)(1, (/)((*)((+)(1, (*)(-1, (getindex)(ğ”“, 2))), (getindex)(ğ”“, 5)), (getindex)(ğ”“, 2)))), (+)(1, (getindex)(ğ”“, 13))), (+)(-1, (getindex)(ğ”“, 7))), (+)(1, (getindex)(ğ”“, 13)))), (^)((+)((/)((*)((*)(-1, (getindex)(ğ”“, 11)), (getindex)(ğ”™, 12)), (+)(1, (*)(1//100, (getindex)(ğ”“, 34)))), (getindex)(ğ”™, 12)), (+)(-1, (*)(-1, (getindex)(ğ”“, 7))))), (getindex)(ğ”“, 7))

(*)((*)((*)((*)(-1, (^)((/)((*)((+)((/)((*)((+)(1, (*)(-1, (getindex)(ğ”“, 2))), (getindex)(ğ”“, 5)), (getindex)(ğ”“, 2)), (getindex)(ğ”™, 56)), (getindex)(ğ”™, 35)), (+)(1, (/)((*)((+)(1, (*)(-1, (getindex)(ğ”“, 2))), (getindex)(ğ”“, 5)), (getindex)(ğ”“, 2)))), (getindex)(ğ”“, 13))), (^)((getindex)(ğ”™, 17), (/)((*)((+)(1, (/)((*)((+)(1, (*)(-1, (getindex)(ğ”“, 2))), (getindex)(ğ”“, 5)), (getindex)(ğ”“, 2))), (getindex)(ğ”“, 2)), (+)(-1, (getindex)(ğ”“, 2))))), (getindex)(ğ”™, 35)), (getindex)(ğ”™, 54))
# 121-element SparseArrays.SparseVector{Float64, Int64} with 5 stored entries:
#   [34]  =  37.8839
#   [57]  =  -6.69165
#   [78]  =  3.72802
#   [82]  =  1.0
#   [91]  =  -24.0024
ğ“‚.jacobian[2]
# 66Ã—121 SparseArrays.SparseMatrixCSC{Float64, Int64} with 298 stored entries:
# â¡â €â €â €â €â €â €â €â €â €â¢€â €â â â €â â¢€â €â €â €â €â ˆâ¡â¢†â â €â¢â¢€â €â¡€â €â €â €â €â €â €â ƒâ „â €â¢€â €â €â¢¨â €â¡€â¡€â €â €â €â €â €â €â¤
# â¢â €â €â €â €â €â €â €â €â €â â €â €â €â €â €â¢â …â €â €â €â €â €â €â €â €â €â¡¸â €â €â €â €â €â ˆâ ¨â €â €â €â €â â …â €â €â €â €â ‡â €â ˆâ €â €â €â €â¥
# â¢â¡€â €â €â €â¡€â¢€â €â¢€â €â¢ˆâ¡€â €â €â €â „â ˆâ ƒâ €â €â €â €â¡€â €â  â €â €â ™â¢€â£€â €â €â €â ¡â “â¡„â €â €â €â Œâ ‚â €â¡€â €â ˆâ ƒâ €â â €â €â €â €â¥
# â¢â €â „â €â €â €â ¡â  â ¨â  â €â €â¢€â ‚â ˆâ €â €â €â €â €â €â €â €â „â  â €â¡€â €â  â €â¢±â €â €â¡„â €â …â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¥
# â¢â €â €â €â ¢â¡€â¡†â €â¢°â €â¢€â €â €â €â €â „â €â †â €â£€â¡˜â¡…â €â €â¢°â €â €â¢°â €â €â €â €â  â  â ˆâ¡†â €â €â €â „â €â €â €â €â €â €â €â €â €â €â €â €â¥
# â¢â €â ˆâ ¢â €â €â ‡â¢€â ¸â €â €â €â €â €â €â €â ˜â €â €â ‘â „â €â €â €â €â €â ‚â ¸â €â¢€â €â €â ‚â €â €â ‡â ‡â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¥
# â¢â €â €â €â €â €â €â €â €â €â  â¡€â €â ‚â €â €â €â €â €â €â €â €â¡„â €â €â €â ˆâ ˆâ €â €â â €â €â €â €â €â ‰â ‚â €â €â €â €â¡„â €â €â ˆâ €â €â ‰â €â €â €â¥
# â¢â €â €â €â €â €â €â €â €â €â €â €â ˆâ €â â €â €â €â €â €â €â  â €â €â €â €â¢€â €â €â „â €â €â €â €â €â €â €â €â ‘â €â €â  â €â¢€â €â „â €â €â €â •â¡„â „â¥
# â¢â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â €â €â €â €â €â €â €â €â €â €â €â €â €â ¡â €â €â €â €â €â €â €â ˆâ „â €â €â €â €â ¡â €â €â €â â¢€â¥
# â¢â €â €â €â €â €â €â €â €â €â €â €â Œâ €â â¢ˆâ €â €â €â €â €â ˆâ ¨â ˜â „â¡â €â €â €â „â €â €â €â €â €â¢€â ˆâ â €â¢€â €â €â €â ‡â €â €â €â €â €â €â €â €â¥
# â¢â ˆâ  â €â €â ˆâ €â …â „â ‡â „â ˆâ â â â €â €â €â €â €â €â €â ˆâ¢€â €â¡€â €â €â €â â €â¡’â €â €â¡€â ¸â €â €â €â €â €â €â â €â €â €â €â €â €â €â €â €â¥
# â¢â €â €â €â €â €â €â €â €â €â €â €â¡ˆâ¢€â „â â €â €â €â €â €â €â¢€â €â €â ‚â €â €â €â €â €â â €â €â ƒâ €â €â¢ â €â â €â €â¡€â €â €â €â €â €â €â €â €â €â¥
# â¢â €â €â €â €â €â €â €â €â €â €â ˆâ €â €â €â£€â €â €â „â €â €â €â ˆâ €â €â €â €â €â €â €â €â €â €â €â €â €â –â ‚â €â¡€â €â €â â €â €â €â €â €â „â €â €â €â¥
# â£â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â â  â €â €â €â €â â €â¢€â¢€â €â ˆâ â €â ‚â â €â „â €â €â €â €â €â €â €â €â â €â €â €â €â „â €â €â €â €â¦
import MacroModelling: calculate_jacobian, calculate_first_order_solution



ğ“‚.dyn_equations[22]

ğ“‚ = Smets_Wouters_2007

include("../test/models/RBC_CME.jl")
include("../test/models/RBC_CME_calibration_equations_and_parameter_definitions.jl")
ğ“‚ = m

SS_and_pars, (solution_error, iters) = ğ“‚.solution.outdated_NSSS ? get_NSSS_and_parameters(ğ“‚, ğ“‚.parameter_values, opts = opts) : (ğ“‚.solution.non_stochastic_steady_state, (eps(), 0))

âˆ‡â‚ = calculate_jacobian(ğ“‚.parameter_values, SS_and_pars, ğ“‚) |> sparse
I, J, V = findnz(âˆ‡â‚)
nan_pos = [66]#findall(isnan, V)
nan_pos[[1,4,7,9]]

âˆ‡â‚[13,34]

if isempty(nan_pos)
    println("No NaN entries found")
    []
else
    rows = I[nan_pos]
    cols = J[nan_pos]
    positions = Tuple.(zip(rows, cols))  # (row, col) pairs
    println("NaN at positions (row, col): ", positions)
    positions
end


Sâ‚, qme_sol, solved = calculate_first_order_solution(âˆ‡â‚; 
                                                    T = ğ“‚.timings, 
                                                    # opts = opts,
                                                    initial_guess = ğ“‚.solution.perturbation.qme_solution)
    